name: Advanced Build and Test ASP.NET Core App

on:
  push:
    branches:
      - main
  
  schedule:
    - cron: '30 11 * * 3,5' 

jobs:
  build:
    runs-on: self-hosted
    outputs:
      VERSION_TAG: ${{ steps.version.outputs.VERSION_TAG }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build Application
        run: |
          mkdir -Force bin/Release 
          dotnet build --configuration Release --no-restore

      - name: Determine Version Tag
        id: version
        run: |
            $BranchName = "${{ github.ref_name }}".Replace("/", "-")
            $ShortHash = $(git rev-parse --short HEAD)
            $VersionTag = "$BranchName-$ShortHash"
            "VERSION_TAG=$VersionTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload Build Artifacts with Versioning
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts--${{ steps.version.outputs.VERSION_TAG }}
          path: '**/bin/Release/net9.0/**'


  test:
    needs: build
    runs-on: self-hosted
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4


    - name: Create TestResults Folder
      run: mkdir TestResults
      
    - name: Run Unit Tests
      run: dotnet test --configuration Release --logger "trx;LogFileName=results.trx" --results-directory TestResults
      continue-on-error: true

      
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
          name: test-results--${{ needs.build.outputs.VERSION_TAG }}
          path: TestResults
          retention-days: 7
  
  code-coverage:
    needs: [build, test]
    runs-on: self-hosted
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build Solution
      run: dotnet build --configuration Release --no-restore

    - name: Run Unit Tests with Code Coverage
      run: dotnet test --configuration Release --no-build --collect:"XPlat Code Coverage" --results-directory TestResults
      continue-on-error: true

    - name: Prepare Coverage Report
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path coverage
        $coverageFile = Get-ChildItem -Path TestResults -Recurse -Filter coverage.cobertura.xml | Select-Object -First 1
        if ($coverageFile) {
          Copy-Item $coverageFile.FullName -Destination coverage\coverage.cobertura.xml
        } else {
          Write-Error "Coverage file not found!"
        }

    - name: Upload Code Coverage Artifact
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage--${{ needs.build.outputs.VERSION_TAG }}
        path: coverage
        retention-days: 7


  sonar:
    name: SonarCloud Analysis
    needs: build
    runs-on: self-hosted
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build Solution
      run: dotnet build --configuration Release --no-restore

    - name: Begin SonarCloud Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        
        dotnet tool install --global dotnet-sonarscanner || echo "SonarScanner already installed"
        dotnet sonarscanner begin /k:"SurajMishraNagarro_AspNetMVCCalculator" /o:"surajmishranagarro" /d:sonar.token="${SONAR_TOKEN}" /d:sonar.cs.opencover.reportsPaths="coverage.xml"

    - name: Run Tests with Coverage
      run: |
        coverlet .\CalculatorApp.Tests\bin\Release\net9.0\CalculatorApp.Tests.dll --target "dotnet" --targetargs "test --no-build" -f=opencover -o "coverage.xml"
      
    - name: End SonarCloud Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"



  # notify:
  #   needs: [build,sonar, test-coverage]
  #   runs-on: self-hosted
  #   steps:
  #     - name: Send Email on Failure
  #       if: failure()
  #       uses: dawidd6/action-send-mail@v3
  #       with:
  #         server_address: smtp.gmail.com
  #         server_port: 587
  #         username: ${{ secrets.EMAIL_USERNAME }}
  #         password: ${{ secrets.EMAIL_PASSWORD }}
  #         subject: " Build or Tests Failed: ${{ github.repository }}"
  #         to: ${{ secrets.TO_EMAIL }}
  #         from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
  #         body: |
  #           Build or Tests Failed for ${{ github.repository }}
  #           Repository: ${{ github.repository }}
  #           Branch: ${{ github.ref }}
  #           Commit: ${{ github.sha }}
  #           Triggered by: ${{ github.actor }}

  #           Check the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
